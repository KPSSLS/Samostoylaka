jQuery(function($){JBZoo.widget('HyperPC.Geo',{'dadataApiKey':''},{init:function($this){$this._defineUserLocation($this);},_subscribeGeoEvents:function($this){$(document).on('hplocationdefined',function(){$this._onLocationDefined();});},_defineUserLocation:function($this,dadataApiKey){if(window.hpGeoAjaxWait){return false;}if(typeof dadataApiKey==='undefined'){dadataApiKey=$this.getOption('dadataApiKey');}var userLocation=$this._getUserLocation($this);if(!userLocation.city){window.hpGeoAjaxWait=true;$.ajax({url:'https://freegeoip.app/json/',dataType:'json',timeout:6000}).done(function(geoipData){if(geoipData.country_code===''){$this._tryDadataIpLocate($this);}else if(geoipData.country_code==='RU'){var $predefinedCity=$('.jsGeoPredefinedCities').eq(0).find('[data-geoid]:contains("'+geoipData.city+'")');if($predefinedCity.length===1){userLocation.country='Россия';userLocation.city=$predefinedCity.text();userLocation.location='';userLocation.fiasId=$predefinedCity.data('fias-id');userLocation.fiasType='city';userLocation.geoId=$predefinedCity.data('geoid');userLocation.zipCode='';$this._saveUserLocation($this,userLocation);window.hpGeoAjaxWait=false;}else{if('Promise'in window){var dadataIplocate=$this._dadataIplocate($this);dadataIplocate.catch(function(){if(geoipData.city===''){$this._saveDefaultUserLocation($this);}else{var locationInfo=[geoipData.city,geoipData.region_name];userLocation.country='Россия';userLocation.city=geoipData.city;userLocation.location=locationInfo.join(', ');userLocation.fiasId='';userLocation.fiasType='';userLocation.geoId=0;userLocation.zipCode=geoipData.zip_code;$this._getYandexAutocomplete(userLocation.location).done(function(yandexResponse){if(yandexResponse.status==='ok'){var locations=yandexResponse.data.suggestions;if(locations.length===1){userLocation.geoId=locations[0].geo_id;}}else{}$this._saveUserLocation($this,userLocation);}).fail(function(error){$this._saveUserLocation($this,userLocation);});}});}else{$this._saveDefaultUserLocation($this);}}}else{if(geoipData.city===''){$this._tryDadataIpLocate($this);}else{userLocation.country=geoipData.country_name;userLocation.city=geoipData.city;userLocation.location='';userLocation.fiasId='';userLocation.fiasType='';userLocation.geoId='';userLocation.zipCode=geoipData.zip_code;$this._saveUserLocation($this,userLocation);}window.hpGeoAjaxWait=false;}}).fail(function(error){$this._tryDadataIpLocate($this);});}else{$this._onLocationDefined();}},_tryDadataIpLocate:function($this){if('Promise'in window){var dadataIplocate=$this._dadataIplocate($this);dadataIplocate.catch(function(){$this._saveDefaultUserLocation($this);});}else{$this._saveDefaultUserLocation($this);}},_dadataIplocate:function($this){return new Promise(function(resolve,reject){var userLocation=$this._getUserLocation($this);$this._getDadataIplocateXhr($this).done(function(dadataResponse){if(dadataResponse.location!==null){var locationData=dadataResponse.location.data;userLocation.country=locationData.country
userLocation.city=locationData.settlement||locationData.city;userLocation.location=dadataResponse.location.unrestricted_value;userLocation.fiasId=locationData.fias_id;userLocation.geoId=0;userLocation.zipCode=locationData.postal_code
if(locationData.fias_id===locationData.city_fias_id){userLocation.fiasType='city';}else if(locationData.fias_id===locationData.settlement_fias_id){userLocation.fiasType='settlement';}$this._getYandexAutocomplete(userLocation.location).done(function(yandexResponse){if(yandexResponse.status==='ok'){var locations=yandexResponse.data.suggestions;if(locations.length===1){userLocation.geoId=locations[0].geo_id;}}else{}$this._saveUserLocation($this,userLocation);}).fail(function(error){$this._saveUserLocation($this,userLocation);});resolve();}else{window.hpGeoAjaxWait=false;reject();}}).fail(function(error){window.hpGeoAjaxWait=false;reject();});});},_saveUserLocation:function($this,userLocation){if($this._localStorageAvailable()){localStorage.setItem('hp_geo_country',userLocation.country||'');localStorage.setItem('hp_geo_city',userLocation.city||'');localStorage.setItem('hp_geo_location',userLocation.location||'');localStorage.setItem('hp_geo_fias_id',userLocation.fiasId||'');localStorage.setItem('hp_geo_fias_type',userLocation.fiasType||'');localStorage.setItem('hp_geo_geoid',userLocation.geoId||'');localStorage.setItem('hp_geo_zipcode',userLocation.zipCode||'');}$(document).trigger('hplocationdefined');},_getUserLocation:function($this){var userLocation=$this._getDefaultUserLocation();if($this._localStorageAvailable()){userLocation={country:localStorage.getItem('hp_geo_country'),city:localStorage.getItem('hp_geo_city'),location:localStorage.getItem('hp_geo_location'),fiasId:localStorage.getItem('hp_geo_fias_id'),fiasType:localStorage.getItem('hp_geo_fias_type'),geoId:localStorage.getItem('hp_geo_geoid'),zipCode:localStorage.getItem('hp_geo_zipcode')};}return userLocation;},_saveDefaultUserLocation:function($this){var userLocation=$this._getDefaultUserLocation();$this._saveUserLocation($this,userLocation);},_localStorageAvailable:function(){var storage;try{storage=window['localStorage'];var x='__storage_test__';storage.setItem(x,x);storage.removeItem(x);return true;}catch(e){return e instanceof DOMException&&(e.code===22||e.code===1014||e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED')&&(storage&&storage.length!==0);}},_getDefaultUserLocation:function(){var userLocation={country:'Россия',city:'Москва',location:'Москва',fiasId:'0c5b2444-70a0-4932-980c-b4dc0d3f02b5',fiasType:'city',geoId:'213',zipCode:''};return userLocation;},_getDadataIplocateXhr:function($this){var serviceUrl="https://suggestions.dadata.ru/suggestions/api/4_1/rs/iplocate/address",params={type:"GET",contentType:"application/json",timeout:6000,headers:{"Authorization":"Token "+$this.getOption('dadataApiKey')}};return $.ajax(serviceUrl,params);},_getYandexAutocomplete:function(term){window.hpGeoAjaxWait=true;return $.ajax({'url':'/index.php?tmpl=component','dataType':'json','type':'POST','data':{'option':'com_hyperpc','task':'delivery.specify-location','format':'raw','term':term}}).always(function(){window.hpGeoAjaxWait=false;});},_onLocationDefined:function(){}});});