jQuery(function($){JBZoo.widget('HyperPC.SiteItemButtons',{'msgAlertError':'','msgTryAgain':'','msgWantRemove':''},{init:function($this){if(!$this.$('.jsCanBeChanged').length){$this.$('.hp-add-to-cart').filter('.jsCreateConfigAddToCart').removeClass('jsCreateConfigAddToCart').addClass('jsAddToCart');}$(window).on('storage',function(e){switch(e.key){case'hp_cart_items':$this._updateCartButtons($this);break;}});$(document).on('updatecartbuttons',function(e){$this._updateCartButtons($this);});},_updateCartButtons:function($this){cartItems=JSON.parse(localStorage.getItem('hp_cart_items'))||[];$buttons=$this.$('.jsCartButtons');$buttons.removeClass('hp-element-in-cart');cartItems.forEach(function(item){if(item.key){$buttons.filter('[data-itemkey="'+item.key+'"]').addClass('hp-element-in-cart');}});},_handleSuccessAddToCart:function($this,itemKey,data){var $buttonsWrapper=$this.$('.jsCartButtons[data-itemkey="'+itemKey+'"]');$buttonsWrapper.addClass('hp-element-in-cart');if($('.jsCartSuccessModal').length>0){UIkit.modal('.jsCartSuccessModal').show();}else{var btnCommonClass='uk-button uk-button-small uk-button-normal@s';var dialogHtml='<div class="jsCartSuccessModal" uk-modal>'+'<div class="uk-modal-dialog tm-background-gray-5">'+'<button class="uk-modal-close-default" type="button" uk-close></button>'+'<div class="uk-modal-body">'+'<div>'+'<span uk-icon="icon: check; ratio: 1.2" class="uk-icon uk-margin-small-right uk-text-success"></span>'+'Добавлено в корзину'+'</div>'+'</div>'+'<div class="uk-modal-footer uk-text-right tm-background-gray-5" uk-margin>'+'<button class="'+btnCommonClass+' uk-button-default uk-modal-close">Продолжить покупки</button> '+'<a href="/cart" class="'+btnCommonClass+' uk-button-primary">Перейти в корзину</a>'+'</div>'+'</div>'+'</div>';UIkit.modal(dialogHtml).show();}if(typeof data.savedConfiguration!=='undefined'){var newItemkey=$this._setSavedConfigurationToItemkey(itemKey,data.savedConfiguration);$buttonsWrapper.data('itemkey',newItemkey).attr('data-itemkey',newItemkey);}$(document).trigger('hpcartupdated',{items:data.items,count:data.count});if(window.location!==window.parent.location){localStorage.setItem('hp_cart_items',JSON.stringify(data.items));localStorage.setItem('hp_cart_items_count',data.count);}},_setSavedConfigurationToItemkey:function(itemKey,configId){var matches=itemKey.match(/^(product-\d+)(-\d+)?$/);if(matches){return matches[1]+'-'+configId;}return itemKey;},_handleFailAddToCart:function($this,msg){var msg=msg||$this.getOption('msgTryAgain');UIkit.notification('<span uk-icon="icon:warning"></span> '+msg+'','danger');},_addToCart:function($this,itemKey,requestData){requestData.format='raw';requestData.option='com_hyperpc';requestData.tmpl='component';$this._openLoader();$.ajax({'url':'/index.php','dataType':'json','method':'POST','data':requestData}).done(function(data){if(data.result===true){$this._handleSuccessAddToCart($this,itemKey,data);}else{$this._handleFailAddToCart($this);}}).fail(function(xjr,error){var msg=error.msg||$this.getOption('msgTryAgain')
$this._handleFailAddToCart($this,msg);}).always(function(){$this._hideLoader();});},_handleAddToCartButton:function($this,$button){var option=$button.data('default-option'),itemKey=$button.closest('.jsCartButtons').data('itemkey');var args={'quantity':1,'id':$button.data('id'),'type':$button.data('type')};if($button.data('stock-id')){args.stock_id=$button.data('stock-id');}if(option!==undefined){args.option=option;}var requestData={'args':args,'task':'cart.addToCart'};$this._addToCart($this,itemKey,requestData);},_handleCreateConfigAddToCartButton:function($this,$button){var itemKey=$button.closest('.jsCartButtons').data('itemkey');var $canBeChangedRows=$this.$('.jsCanBeChanged');$isDefaultConfig=true;$canBeChangedRows.filter('[data-changed-item]').each(function(){var $row=$(this);if($row.data('changedItem')!==$row.data('defaultItemkey')){$isDefaultConfig=false;return false;}});if($isDefaultConfig){$this._handleAddToCartButton($this,$button);}else{var id=$button.data('id'),method='toggle-parts',args={},j=0;$canBeChangedRows.each(function(i){var $part=$(this),defaultItemkey=$part.data('defaultItemkey');args[i]={'default':null,'part-id':$part.find('.jsGroupPartValue').val(),'option-id':$part.find('.jsGroupOptionValue').val()};if(window.HpProductDefaultParts[defaultItemkey]){args[i].default={'part':window.HpProductDefaultParts[defaultItemkey].part_id,'option':window.HpProductDefaultParts[defaultItemkey].option_id};}});if(Object.keys(args).length){var requestData={'id':id,'args':args,'method':method,'task':'cart.add-product-and-create-config'};$this._addToCart($this,itemKey,requestData);}}},'click .jsAddToCart':function(e,$this){e.preventDefault();var $button=$(this);$this._handleAddToCartButton($this,$button);},'click .jsCreateConfigAddToCart':function(e,$this){var $button=$(this);$this._handleCreateConfigAddToCartButton($this,$button);e.preventDefault();}});});