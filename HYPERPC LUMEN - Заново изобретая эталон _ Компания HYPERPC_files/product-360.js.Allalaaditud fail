jQuery(function($){JBZoo.widget('HyperPC.Product360',{sensetive:20,demobstrationOffset:8},{resourceLoaded:false,framesCount:1,currentStep:1,frameSize:0,touch:'',touchDetecting:false,swipeStarted:false,delta:0,keyFrame:1,overlayRemoved:false,init:function($this){},_showLoader:function($this){$this.el.addClass('tm-product-360--loader').append('<span class="uk-position-cover uk-flex uk-flex-middle uk-flex-center" uk-spinner="ratio:2"></span>');if($this._collectInitData($this)){var image=document.createElement('img');image.addEventListener('load',function(e){$this._handleLoadedResource($this,image);});image.src=$this.sprite;}},_handleLoadedResource:function($this,image){if(image.width===0||image.height===0){console.error('Cannot init HyperPCProduct360 widget (invalid source)');$this._reset($this);}else{$this._hideLoader($this,image);$this.resourceLoaded=true;var resizeTimer;$(window).on('resize',function(e){clearTimeout(resizeTimer);resizeTimer=setTimeout(function(){$this._defineFrameSize($this);$this._updatePosition($this);},250);});}},_hideLoader:function($this,image){$this.el.css('opacity',0.25);setTimeout(function(){$this.$('.tm-product-360__preview-img').css('visibility','hidden');$this.$('[uk-spinner]').remove();$this.$('.tm-product-360__overlay').css('cursor','grab');$this.$('.jsProduct360TextPreload').remove();$this.$('.jsProduct360TextPostload').removeAttr('hidden');$this.el.removeClass('tm-product-360--loader').css('cursor','grab').css('backgroundImage','url('+image.src+')').css('opacity',1);},500);},_demonstrate:function($this){$this._defineFrameSize($this);var framesOffset=$this.getOption('demobstrationOffset'),iterations=framesOffset*4,i=0;var interval=setInterval(function(){if(i<framesOffset){$this._stepForward($this);}else if(i>=framesOffset&&i<framesOffset*3){$this._stepBack($this);}else if(i>=framesOffset*3&&i<framesOffset*4){$this._stepForward($this);}if(i===iterations){clearInterval(interval);$this.resourceLoaded=true;}i++;},67);},_stepBack:function($this){$this.currentStep=$this.currentStep-1;if($this.currentStep<1){$this.currentStep=$this.framesCount+$this.currentStep;}$this._updatePosition($this);},_stepForward:function($this){$this.currentStep=$this.currentStep+1;if($this.currentStep>$this.framesCount){$this.currentStep=$this.currentStep-$this.framesCount;}$this._updatePosition($this);},_collectInitData:function($this){var props=$this._parseDataAttr($this);if(typeof props.sprite==='undefined'||typeof props.frames==='undefined'){console.error('Cannot init HyperPCProduct360 widget');$this._reset($this);return false;}$this.framesCount=parseInt(props.frames);$this.sprite=props.sprite;return true;},_reset:function($this){$this.el.removeClass('tm-product-360--loader').find('[uk-spinner], .tm-product-360__overlay').remove();},_parseDataAttr:function($this){var data=$this.el.data('product-360'),stringProps=data.split(';'),props={};if(stringProps.length>1){stringProps.forEach(function(prop){if(prop.indexOf(':')>0){var parsedProp=prop.split(':');if(parsedProp.length===2){props[parsedProp[0].trim()]=parsedProp[1].trim();}}});}else{var parsedProp=stringProps.join().split(':');if(parsedProp.length===2){props[parsedProp[0].trim()]=parsedProp[1].trim();}}return props;},_updatePosition:function($this){$this.el.css('backgroundPositionX',($this.frameSize-($this.frameSize*$this.currentStep)));},_defineFrameSize:function($this){var blockWidth=$this.el.width();$this.el.css('backgroundSize',blockWidth*$this.framesCount);$this.frameSize=blockWidth;},_handleTouchStart:function($this,e){$this.touch=e.originalEvent.type==='touchstart'?e.originalEvent.changedTouches[0]:e.originalEvent;$this.touchDetecting=true;$this.keyFrame=$this.currentStep;},_handleMove:function($this,e){var x=$this.touch.clientX,y=$this.touch.clientY,newX=e.originalEvent.clientX,newY=e.originalEvent.clientY;if(e.originalEvent.type==='touchmove'){newX=e.originalEvent.changedTouches[0].clientX;newY=e.originalEvent.changedTouches[0].clientY;}if($this.touchDetecting){if(Math.abs(x-newX)>=Math.abs(y-newY)){e.preventDefault();$this.swipeStarted=true;}$this.touchDetecting=false;}if($this.swipeStarted){e.preventDefault();$this.delta=x-newX;}var framesDiff=Math.floor($this.delta/$this.getOption('sensetive'));$this.currentStep=$this.keyFrame+framesDiff;if($this.currentStep>$this.framesCount){$this.currentStep=$this.currentStep-$this.framesCount;}else if($this.currentStep<1){$this.currentStep=$this.framesCount-Math.abs($this.currentStep);}$this._updatePosition($this);if(!$this.overlayRemoved){$this.$('.tm-product-360__overlay').css('visibility','hidden');}},_handleTouchEnd:function($this){$this.delta=0;$this.swipeStarted=false;$this.touchDetecting=false;$this.keyFrame=$this.currentStep;if(!$this.overlayRemoved){$this.$('.tm-product-360__overlay').remove();$this.overlayRemoved=true;}},'mousedown .tm-product-360__overlay':function(e,$this){if(!$this.resourceLoaded){$this._showLoader($this);}},'touchstart {element}':function(e,$this){if(!$this.resourceLoaded||e.originalEvent.touches.length!=1){return;}$this._defineFrameSize($this);$this._handleTouchStart($this,e);},'mousedown {element}':function(e,$this){if(!$this.resourceLoaded){return;}$this._defineFrameSize($this);$this._handleTouchStart($this,e);$this.el.css('cursor','');$('body').css('cursor','grabbing');},'touchmove {element}':function(e,$this){if(!$.inArray($this.touch,e.originalEvent.changedTouches)){return;}if(!$this.swipeStarted&&!$this.touchDetecting){if(!$this.resourceLoaded){$this._showLoader($this);}return;}$this._handleMove($this,e);},'mousemove {document} body':function(e,$this){if(!$this.resourceLoaded||(!$this.swipeStarted&&!$this.touchDetecting)){return;}$this._handleMove($this,e);},'touchend {element}':function(e,$this){if(!$this.resourceLoaded||!$this.swipeStarted){return;}$this._handleTouchEnd($this);e.preventDefault();},'mouseup {document} body':function(e,$this){if(!$this.resourceLoaded||!$this.swipeStarted){return;}$this._handleTouchEnd($this);$('body').css('cursor','');$this.el.css('cursor','grab');e.preventDefault();}});});