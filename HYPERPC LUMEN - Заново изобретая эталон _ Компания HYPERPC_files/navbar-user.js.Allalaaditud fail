jQuery(function($){JBZoo.widget('HyperPC.NavbarUser',{'cartItemsLimit':3},{init:function($this){$(window).on('storage',function(e){switch(e.key){case'hp_cart_items_count':$this._onCartItemsCountChange($this);break;case'hp_compared_items_count':$this._onComparedItemsCountChange($this);break;case'hp_unseen_notifications':$this._onUnseenNotificationsChange($this);break;}});localStorage.removeItem('hp_update_cart_now');var $document=$(document);$document.on('hpcartupdated',function(e,data){$this._onCartUpdated($this,data);});$document.on('hpcompareupdated',function(e,data){$this._onCompareUpdated($this,data);});$document.on('hpuserloggedin',function(e,data){$this._onUserLoggedIn($this,data);});$document.on('hpuserloggedout',function(e){$this._onUserLoggedOut($this);});$('.jsAuthFirstStep').find('.jsAuthEmail').on('input',function(e){$('.jsAuthEmailMask').text($(e.target).val());});$('.jsAuthSecondStep').find('[name^="pwd"]').on('input',function(e){const $input=$(this);if($input.val().length>0){const index=$input.data('code');if(index<3){$input.closest('.jsAuthSecondStep').find('[data-code="'+(index+1)+'"]').focus();}}});$this._initNotificatioMarkState($this);},_initNotificatioMarkState:function($this){var notificationChecked=localStorage.getItem('hp_notifications_last_check');var currentDate=Date.now();if(notificationChecked===null||currentDate-notificationChecked>this.options.notificationRemindTime){$this._showNotificationMark($this);return;}var actualCartItemsCount=$this._getCurrentCartItemsCount($this);var actualComparedItemsCount=$this._getCurrentComparedItemsCount($this);if(localStorage.getItem('hp_unseen_notifications')==1){if(actualCartItemsCount!==0){$this._showNotificationMark($this);}else{localStorage.setItem('hp_unseen_notifications',0);}}localStorage.setItem('hp_cart_items_count',actualCartItemsCount);localStorage.setItem('hp_compared_items_count',actualComparedItemsCount);},_onCartUpdated:function($this,data){if(typeof data!=='undefined'&&typeof data.count!=='undefined'&&typeof data.items!=='undefined'){localStorage.setItem('hp_cart_items',JSON.stringify(data.items));$this._updateCartItemsList($this,data.items);localStorage.setItem('hp_cart_items_count',data.count);$this._setCartItemsCount($this,data.count);}else{var xhr=$.ajax({'url':'/index.php','dataType':'json','type':'POST','data':{'option':'com_hyperpc','task':'cart.get-items-count','format':'raw'}});xhr.done(function(response){localStorage.setItem('hp_cart_items_count',response.count);$this._setCartItemsCount($this,response.count);});}},_updateCartItemsList:function($this,items){items=items||JSON.parse(localStorage.getItem('hp_cart_items'));if(items.length>0){$this.$('.jsNavbarUserCartItemsWrapper').removeAttr('hidden');var cartIemsHtml='';for(var i=0;i<items.length;i++){var item=items[i];var html='<li class="jsNavbarUserCartItem">'+(item.url.length?'<a href="'+item.url+'" class="uk-link-reset" target="_blank">':'')+'<span class="uk-flex uk-flex-middle">'+'<span class="uk-flex-none hp-navbar-user-cart-list__item-image">'+'<img src="'+item.image+'" alt="" class="uk-responsive-height">'+'</span>'+'<span>'+item.name+'</span>'+'</span>'+(item.url.length?'</a>':'')+'</li>';cartIemsHtml+=html;}$this.$('.jsNavbarUserCartItems').html(cartIemsHtml);if(items.length>$this.getOption('cartItemsLimit')&&$this.$('[uk-dropdown]').hasClass('uk-open')){$this._checkCartItems($this);}else{$this.$('.jsHiddenItemsCount').parent().attr('hidden','hidden');}}else{$this.$('.jsNavbarUserCartLink').removeAttr('hidden');$this.$('.jsNavbarUserCartItemsWrapper').attr('hidden','hidden').find('.jsNavbarUserCartItems').html('');}},_onCartItemsCountChange:function($this){$this._setCartItemsCount($this);$this._updateCartItemsList($this);},_setCartItemsCount:function($this,itemsCount){var count=itemsCount||localStorage.getItem('hp_cart_items_count');var $countEl=$this.$('.jsCartItemsCount');var $badge=$this.$('.jsNavbarUserActionBadge');var currentCount=$this._getCurrentCartItemsCount($this);$countEl.html('('+count+')');$badge.html(count);if(count==0){$countEl.addClass('uk-hidden');$badge.attr('hidden','hidden');}else{$countEl.removeClass('uk-hidden');$badge.removeAttr('hidden');$this.$('.hp-navbar-user__toggle').removeClass('hp-navbar-user__toggle--has-notification');if(count>currentCount){localStorage.setItem('hp_unseen_notifications',1);$this._showNotificationMark($this);}}},_getCurrentCartItemsCount:function($this){return parseInt($this.$('.jsCartItemsCount').text().trim().replace(/[()]/g,''))||0;},_onCompareUpdated:function($this,data){if(typeof data!=='undefined'&&typeof data.totalCount!=='undefined'){localStorage.setItem('hp_compared_items_count',data.totalCount);$this._setComparedItemsCount($this,data.totalCount);}},_onComparedItemsCountChange:function($this){$this._setComparedItemsCount($this);},_setComparedItemsCount:function($this,itemsCount){var count=itemsCount||localStorage.getItem('hp_compared_items_count'),$countEl=$this.$('.jsNavbarUserCompareBadge'),$hiddenEl=$this.$('.jsNavbarUserCompare');$countEl.html(count);if(count==0){$hiddenEl.attr('hidden','hidden');}else{$hiddenEl.removeAttr('hidden');}},_getCurrentComparedItemsCount:function($this){return parseInt($this.$('.jsNavbarUserCompareBadge').text().trim())||0;},_hideNotificationMark:function($this){$this.$('.hp-navbar-user__toggle').removeClass('hp-navbar-user__toggle--has-notification');},_showNotificationMark:function($this){if($this.$('.jsNavbarUserActionBadge').length>0&&$this.$('.jsNavbarUserActionBadge').is('[hidden]')){$this.$('.hp-navbar-user__toggle').addClass('hp-navbar-user__toggle--has-notification');}},_onUnseenNotificationsChange:function($this){if(localStorage.getItem('hp_unseen_notifications')==1){$this._showNotificationMark($this);}else if(localStorage.getItem('hp_unseen_notifications')==0){$this._hideNotificationMark($this);}},_checkCartItems:function($this){var $cartItems=$this.$('.jsNavbarUserCartItem');if($cartItems.length===0){return false;}var limit=Math.min($this.getOption('cartItemsLimit'),$cartItems.length);var hidenItems=$cartItems.length-limit;if(hidenItems>0){$cartItems.removeAttr('hidden');$cartItems.slice(limit).attr('hidden','hidden');$this.$('.jsHiddenItemsCount').html($this._getCountText(hidenItems)).parent().removeAttr('hidden');}else{$this.$('.jsHiddenItemsCount').parent().attr('hidden','hidden');}$this.$('.jsNavbarUserCartItemsWrapper').removeAttr('hidden');$this.$('.jsNavbarUserCartLink').attr('hidden','hidden');var heightDiff=$(window).height()-($this.$('[uk-dropdown]').outerHeight()+$this.$('[uk-dropdown]').position().top);if(heightDiff<0){if(Math.abs(heightDiff)>=$this.$('.jsNavbarUserCartItems').outerHeight()){$this.$('.jsNavbarUserCartItemsWrapper').attr('hidden','hidden');$this.$('.jsNavbarUserCartLink').removeAttr('hidden');}else{var $visibleItems=$cartItems.not('[hidden]');$($visibleItems.get().reverse()).each(function(){var $item=$(this);var itemHeight=$item.outerHeight()+parseInt($item.css('marginTop'));$item.attr('hidden','hidden');heightDiff+=itemHeight;if(heightDiff>=0){return false;}});var $actualVisible=$cartItems.not('[hidden]');$this.$('.jsHiddenItemsCount').html($this._getCountText($cartItems.length-$actualVisible.length)).parent().removeAttr('hidden');if(heightDiff<0||$actualVisible.length===0){$this.$('.jsNavbarUserCartItemsWrapper').attr('hidden','hidden');$this.$('.jsNavbarUserCartLink').removeAttr('hidden');}}}},_getCountText:function(number,titles){if(typeof titles==='undefined'){titles=['товар','товара','товаров']}cases=[2,0,1,1,1,2];return number+' '+titles[(number%100>4&&number%100<20)?2:cases[(number%10<5)?number%10:5]];},_onUserLoggedIn:function($this,data){$this.$('.jsNavbarUserDropItemAuthed').removeAttr('hidden');$this.$('.jsNavbarUserDropItemGuest').attr('hidden','hidden');$this.$('.jsNavbarUserDropUsername').text(data.username);$this._setLogoutToken($this,data.token);window.user={id:data.id,name:data.name,email:data.email};},_setLogoutToken:function($this,token){var $logoutLink=$this.$('.jsUserLogoutLink');var logoutHref=$logoutLink.attr('href');var newLogoutHref=logoutHref.replace(/^(.+&)([a-z0-9]{32})(=1.*)$/,'$1'+token+'$3');$this.$('.jsUserLogoutLink').attr('href',newLogoutHref);},_onUserLoggedOut:function($this){$this.$('.jsNavbarUserDropItemAuthed').attr('hidden','hidden');$this.$('.jsNavbarUserDropItemGuest').removeAttr('hidden');$this.$('.jsNavbarUserDropUsername').text('');window.user={id:0,name:null,email:null};},_handleFormAjaxFail:function($form,message){if(!message){message='Что-то пошло не так. Попробуйте еще раз.';}$form.prepend('<div class="uk-alert uk-alert-danger" uk-alert>'+'<a class="uk-alert-close" uk-close></a>'+message+'</div>');},_lockFormSubmitButton:function($form){$form.find('[type="submit"]').prepend('<span uk-spinner="ratio: 0.7"></span>').attr('disabled','disabled');},_unlockFormSubmitButton:function($form){$form.find('[type="submit"]').removeAttr('disabled').find('[uk-spinner]').remove();},'show [uk-dropdown]':function(e,$this){localStorage.setItem('hp_unseen_notifications',0);localStorage.setItem('hp_notifications_last_check',Date.now());$this._hideNotificationMark($this);$this._checkCartItems($this);},'submit {document} .jsRegistrationAjaxForm':function(e,$this){e.preventDefault();var $form=$(this);$form.find('[uk-alert]').remove();$this._lockFormSubmitButton($form);$.ajax({'url':'/index.php?'+$form.serialize(),'dataType':'json','type':'POST','timeout':15000,'data':{'option':'com_hyperpc','task':'user.ajax-registration','tmpl':'component'}}).done(function(response){if(response.result){$('.jsAuthAjaxForm').prepend('<div class="uk-alert uk-alert-success" uk-alert>'+'<a class="uk-alert-close" uk-close></a>'+response.message+'</div>');UIkit.switcher($form.closest('[uk-modal]').find('[uk-switcher]')).show(0);}else{$form.prepend('<div class="uk-alert uk-alert-danger" uk-alert>'+'<a class="uk-alert-close" uk-close></a>'+response.message+'</div>');}}).fail(function(){$this._handleFormAjaxFail($form)}).always(function(){$this._unlockFormSubmitButton($form);});},'submit {document} .jsAuthAjaxForm':function(e,$this){e.preventDefault();var $form=$(this),username=$form.find('input[name=username]'),password=$form.find('input[name=password]'),remember=$form.find('input[name=remember]');var formSerialize=username.val()+':'+encodeURI(password.val())+':'+remember.prop('checked'),formHash=window.btoa(formSerialize);$form.find('[uk-alert]').remove();$this._lockFormSubmitButton($form);$.ajax({'url':'/index.php?'+$form.serialize(),'dataType':'json','type':'POST','timeout':15000,'data':{'option':'com_hyperpc','tmpl':'component','task':'user.ajax-login','data':formHash}}).done(function(response){var alertStyle=response.result?'uk-alert-success':'uk-alert-danger';$form.prepend('<div class="uk-alert '+alertStyle+'" uk-alert>'+'<a class="uk-alert-close" uk-close></a>'+response.message+'</div>');if(response.result){$(document).trigger('hpuserloggedin',response.user);}setTimeout(function(){UIkit.modal('#login-form-modal').hide();$form.find('[uk-alert]').remove();},1000);}).fail(function(){$this._handleFormAjaxFail($form);}).always(function(){$this._unlockFormSubmitButton($form);});},'submit {document} .jsAuthFirstStep':function(e,$this){e.preventDefault();const data={'option':'com_hyperpc','task':'auth.step-one','tmpl':'component','format':null,};const $form=$(this);$form.find('input').each(function(){const $input=$(this);if($input.is('[type="checkbox"]')){data[$input.attr('name')]=$input.prop('checked');}else{data[$input.attr('name')]=$input.val();}});$form.find('[uk-alert]').remove();$this._lockFormSubmitButton($form);$.ajax({'method':'POST','data':data,'dataType':'json','timeout':15000,}).done(function(data){if(data.result){const user=atob(data.user).split('::');$this.userId=user[0];$this.codeId=user[1];$this.newUserRegistered=data.new;$form.attr('hidden','hidden');const $wrapper=$form.closest('.jsAuthWrapper');$wrapper.find('.jsAuthGoBack').removeAttr('hidden');$wrapper.find('.jsAuthSecondStep').removeAttr('hidden').append('<input type="hidden" name="'+data.token+'" value="1">').find('[name*="pwd[0]"]').focus();}else{$this._handleFormAjaxFail($form,data.message);$this._unlockFormSubmitButton($form);}}).fail(function(response){$this._handleFormAjaxFail($form);$this._unlockFormSubmitButton($form);});},'submit {document} .jsAuthSecondStep':function(e,$this){e.preventDefault();const $form=$(this);const data={'option':'com_hyperpc','task':'auth.step-two','tmpl':'component','format':null,'user_id':$this.userId,'code_id':$this.codeId,};$form.find('input').each(function(){const $input=$(this);if($input.is('[type="checkbox"]')){data[$input.attr('name')]=$input.prop('checked');}else{data[$input.attr('name')]=$input.val();}});$form.find('[uk-alert]').remove();$this._lockFormSubmitButton($form);$.ajax({'method':'POST','data':data,'dataType':'json','timeout':15000,}).done(function(response){if(response.result){$form.prepend('<div class="uk-alert uk-alert-success" uk-alert>'+'<a class="uk-alert-close" uk-close></a>'+response.message+'</div>');$(document).trigger('hpuserloggedin',response.user);if($this.newUserRegistered){window.dataLayer&&window.dataLayer.push({'event':'hpTrackedAction','hpAction':'userRegistered'});}if($form.closest('.hp-auth-card').length){location.href='/account';}else{setTimeout(function(){UIkit.modal('#login-form-modal').hide();$form.find('[uk-alert]').remove();},1000);}}else{$this._handleFormAjaxFail($form,response.message);}}).fail(function(response){$this._handleFormAjaxFail($form);}).always(function(){$this._unlockFormSubmitButton($form);});},'click {document} .jsAuthGoBack':function(e,$this){e.preventDefault();const $backButton=$(this),$wrapper=$backButton.closest('.jsAuthWrapper'),$firstStepForm=$wrapper.find('.jsAuthFirstStep');$backButton.attr('hidden','hidden');$firstStepForm.removeAttr('hidden');$wrapper.find('.jsAuthSecondStep').attr('hidden','hidden');$wrapper.find('[uk-alert]').remove();$this._unlockFormSubmitButton($firstStepForm);}});});